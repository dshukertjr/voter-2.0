<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-user">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 8px;
        -webkit-animation: fadeIn 0.2s 1;
        animation: fadeIn 0.2s 1;
      }

      .highlightBtn{
        background:var(--app-primary-color);
        color:#fff;
      }
    </style>

    <firebase-auth 
      app-name="drink"
      app="{{firebase}}"
      id="auth" 
      user="{{user}}" 
      on-error="handleError">
    </firebase-auth>

    <firebase-document
      app-name="drink"
      id="userPublic"
      path="/users/public/[[user.uid]]"
      data="{{userPublic}}">
    </firebase-document>

    <firebase-document
      app-name="drink"
      id="userPrivate"
      path="/users/private/[[user.uid]]"
      data="{{userPrivate}}">
    </firebase-document>

    <div class="card">

    <div hidden$="[[user]]">
      
    </div>

      <div hidden$="[[isUniqueUser]]">
        <paper-input id="email" type="email" label="email"></paper-input>
        <paper-input type="password" id="password" label="password"></paper-input>

        <div class="buttons">
          <paper-button on-tap="login" class="highlightBtn" raised>ログイン</paper-button>
          <paper-button on-tap="signup" raised>新規登録</paper-button>
        </div>
      </div>

      <div hidden$="[[!isUniqueUser]]">
        <paper-input id="userName" value="[[userPublic.userName]]" type="text" label="User Name"></paper-input>

        <div class="buttons">
          <paper-button on-tap="saveUserData" class="highlightBtn" raised>保存</paper-button>
        </div>

        <div class="buttons alignCenter">
          <paper-button on-tap="signout">ログアウトする</paper-button>
        </div>

      </div>

    </div>

    <paper-toast raised id="toast" text=""></paper-toast>

  </template>

  <script>
    class MyUser extends Polymer.Element {
      static get is() { return 'my-user'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: 'setPageTitle'
          },
          firebase: Object,
          userPublic: Object,
          userPrivate: Object,
          pageTitle: {
            type: String,
            notify: true
          },
          selected: { //used to determine if selected by iron pages as the current page
            type: Boolean,
            observer: 'setPageTitle'
          },
          isUniqueUser: {
            //if true, is a email logged in user
            type: Boolean, 
            computed: 'checkUniqueUser(user)',
            value: false
          },
          isCoorporate: {
            type: Boolean,
            notify:true
          }
        };
      }

      setPageTitle(){
        if(this.selected){
          this.isCoorporate = false;
          if(this.isUniqueUser){
            this.pageTitle = "User Settings";
          }else{
            this.pageTitle = "Login";
          }
        }
      }

      checkUniqueUser(){
        return this.user && !this.user.isAnonymous;
      }

      login(){
        const toast = this.$.toast;
        const email = this.$.email.value;
        const password = this.$.password.value;

        if(this.user){
          //if not signed in, sign in first
          this.$.auth.signOut();
        }

        toast.text = "ログイン中...";
        toast.open();

        this.$.auth.signInWithEmailAndPassword(email, password)
        .then(function(response){
          toast.text = "ログインが完了しました";
          toast.open();
          email = null;
          password = null;
        }, function(error){
          toast.text = "ログインできませんでした";
          toast.open();
          console.log(error);
        });
      }

      signup(){
        const toast = this.$.toast;
        const email = this.$.email.value;
        const password = this.$.password.value;
        const firebase = this.firebase;
        const auth = firebase.auth();

        if(!this.user){
          //simply create user from scratch
          this.$.auth.createUserWithEmailAndPassword(email, password)
          .then(function(response){
            toast.text = "ユーザー登録が完了しました";
            toast.open();
          }, function(error){
            console.log(error);
          });
        }else{

          //if not signed in, sign in first
          this.$.auth.signOut();
          
          this.$.auth.createUserWithEmailAndPassword(email, password)
          .then(function(response){
            toast.text = "ユーザー登録が完了しました";
            toast.open();
          }, function(error){
            console.log(error);
          });



          // if(this.user.isAnonymous){
          //   //merge account
          //   console.log(firebase.auth());
          //   console.log(firebase.auth);
          //   console.log(auth.currentUser);

          //   var credential = firebase.auth.EmailAuthProvider.credential(email, password);
          //   console.log(credential);
          //   auth.currentUser.link(credential).then(function(user) {
          //     toast.text = "ユーザー登録が完了しました";
          //     toast.open();
          //   }, function(error) {
          //     console.log("Error upgrading anonymous account", error);
          //   });
          // }
        }
      }

      signout(){
        this.$.auth.signOut();
        this.$.toast.text = "ログアウトしました";
        this.$.toast.open();
      }

      saveUserData() {
        if(this.user){
          const toast = this.$.toast;
          const userData = {
            userName: this.$.userName.value
          }
          this.$.userPublic.ref.set(userData).then(function(){
            toast.text = "ユーザー情報の更新が完了しました";
            toast.open();
          });
        }
      }

       post() {
        var question = {
          "meta": {
            "Uid": this.user.uid,
            "question": this.$.question.value,
            "choice1": this.$.choice1.value,
            "choice2": this.$.choice2.value
          }
        }
        // if(this.$.afterMessage.value != null) data["afterMessage"] = this.$.afterMessage.value;
        if(this.$.choice3.value != null) question["meta"]["choice3"] = this.$.choice3.value;
        if(this.$.choice4.value != null) question["meta"]["choice4"] = this.$.choice4.value;
        if(this.$.choice5.value != null) question["meta"]["choice5"] = this.$.choice5.value;

        var query = this.$.query;
        if(!this.user){
          //if not signed in, sign in first
          this.$.auth.signInAnonymously()
          .then(function(response){
            query.ref.push(question);
          });
        }else{
          this.$.query.ref.push(question);
        }
      }

    }

    window.customElements.define(MyUser.is, MyUser);
  </script>
</dom-module>